# redis集群部署以及搭建

ps:

redis搭建转载至博主:凉凉的西瓜

https://blog.csdn.net/qq_42815754/article/details/82912130

## redis集群

搭建完redis后(包括下载，daemonize no -> daemonize yes等)进行集群配置。

### Redis Cluster 简介
- redis是一个开源的key value存储系统，受到了广大互联网公司的青睐。redis3.0版本之前只支持单例模式，在3.0版本及以后才支持集群；
- redis集群采用P2P模式，是完全去中心化的，不存在中心节点或者代理节点；
redis集群是没有统一的入口的，客户端（client）连接集群的时候连接集群中的任意节点（node）即可，集群内部的节点是相互通信的（PING-PONG机制），每个节点都是一个redis实例；
- 为了实现集群的高可用，即判断节点是否健康（能否正常使用），redis-cluster有这么一个投票容错机制：如果集群中超过半数的节点投票认为某个节点挂了，那么这个节点就挂了（fail）。这是判断节点是否挂了的方法；
- 那么如何判断集群是否挂了呢? -> 如果集群中任意一个节点挂了，而且该节点没有从节点（备份节点），那么这个集群就挂了。这是判断集群是否挂了的方法；
- 那么为什么任意一个节点挂了（没有从节点）这个集群就挂了呢？ -> 因为集群内置了16384个slot（哈希槽），并且把所有的物理节点映射到了这16384[0-16383]个slot上，或者说把这些slot均等的分配给了各个节点。当需要在Redis集群存放一个数据（key-value）时，redis会先对这个key进行crc16算法，然后得到一个结果。再把这个结果对16384进行求余，这个余数会对应[0-16383]其中一个槽，进而决定key-value存储到哪个节点中。所以一旦某个节点挂了，该节点对应的slot就无法使用，那么就会导致集群无法正常工作。
- 综上所述，每个Redis集群理论上最多可以有16384个节点。

### Redis 集群所需要的环境
1. Redis集群至少需要3个节点，因为投票容错机制要求超过半数节点认为某个节点挂了该节点才是挂了，所以2个节点无法构成集群。
2. 要保证集群的高可用，需要每个节点都有从节点，也就是备份节点，所以Redis集群至少需要6台服务器（3主3从）。此实例使用端口:(7000~7005)

#### 1.redis目录
在安装编译后make install PREFIX=/usr/local/redis 的目录下创建3个文件夹，用来存放redis相关配置

[![RrWuOx.png](https://z3.ax1x.com/2021/07/01/RrWuOx.png)](https://imgtu.com/i/RrWuOx)

#### 2.配置redis.conf
配置文件内容:


```
#端口
port 7000
#是否以守护进程的方式运行
daemonize yes
#绑定的主机地址 集群主修改为0.0.0.0
bind 0.0.0.0
#生成pid文件位置
pidfile "/home/redis/rediscluster7000/logs/redis-7000.pid"
#日志文件
logfile "/home/redis/rediscluster7000/logs/redis-7000.log"
#指定本地数据库存放目录
dir "/home/redis/rediscluster7000/data"
#指定本地数据库文件名，默认值为dump.rdb
dbfilename "redis-7000.rdb"
#设置同一时间最大客户端连接数，默认无限制
maxclients 1000
#指定Redis最大内存限制
maxmemory 16gb
maxmemory-policy noeviction
#密码
requirepass "password"
#当master服务设置了密码保护时，slav服务连接master的密码
masterauth "password"
#是否启用集群
cluster-enabled yes
cluster-config-file "nodes-7000.conf"
cluster-node-timeout 15000
cluster-require-full-coverage no
# Generated by CONFIG REWRITE
#指定是否在每次更新操作后进行日志记录
appendonly yes
notify-keyspace-events "gEx"
```
将配置文件放入config文件夹内，并重命名为redis-7000.conf 代表在7000端口下启动。

将配置文件复制5份，端口修改为7001-7005

[![RrHjb9.png](https://z3.ax1x.com/2021/07/01/RrHjb9.png)](https://imgtu.com/i/RrHjb9)

### 3.启动redis(配置启动脚本)
分别各自启动redis，命令实例redis-server redis-700*.conf

将命令作为启动脚本

vim redis-cluster-startup.sh

chmod +x redis-cluster-startup.sh

```
/usr/local/rediscluster7000/bin/redis-server /usr/local/rediscluster7000/config/redis-7000.conf
/usr/local/rediscluster7001/bin/redis-server /usr/local/rediscluster7001/config/redis-7001.conf
/usr/local/rediscluster7002/bin/redis-server /usr/local/rediscluster7002/config/redis-7002.conf
/usr/local/rediscluster7003/bin/redis-server /usr/local/rediscluster7003/config/redis-7003.conf
/usr/local/rediscluster7004/bin/redis-server /usr/local/rediscluster7004/config/redis-7004.conf
/usr/local/rediscluster7005/bin/redis-server /usr/local/rediscluster7005/config/redis-7005.conf
```
### 4.使用redis-cli创建集群 (不使用ruby)
redis 从5开始 可以直接用redis-cli命令创建集群了,不用那么麻烦 安装ruby环境 

linx命令:
注意:请使用外网ip 不然外网无法访问，以下命令只是示例

./redis-cli --cluster create 192.168.0.1:7000 192.168.0.1:7001 192.168.0.1:7002 192.168.0.1:7003 192.168.0.1:7004 192.168.0.1:7005 --cluster-replicas 1 -a password

[![RrLzUs.png](https://z3.ax1x.com/2021/07/01/RrLzUs.png)](https://imgtu.com/i/RrLzUs)


使用./redis-cli -h 127.0.0.1 -c -p 7000 info replication 查看状态

### 5.注意事项
服务器上记得放开安全组 包括redis集群端口+10000

集群重新配置需要删除data文件下的.rdb文件

### 6.记录问题
目前遇到问题，redis集群本地正常操作，但是远程连接访问断断续续，连接端口修改为7001等正常。

环境：

阿里云端口开放 7000-7005 17000-17005

redis配置文件:

bind 0.0.0.0 

protected-mode no 

daemonize yes